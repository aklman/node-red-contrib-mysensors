<script type="text/javascript">
    RED.nodes.registerType('myscontroller',{
        category: 'mysensors',
        color: '#a6bbcf',
        defaults: {
            database: {value:"", type: "mysensorsdb"},
            name: {value:""},
            handleid: {value: true}
        },
        inputs:1,
        outputs:1,
        icon: "cog.png",
        label: function() {
            return this.name||"myscontroller";
        },
        oneditprepare: function() {
            $.getJSON('mysensornodes/' + this.database, function(data) {
                data = JSON.parse(data).data;
                var html = '';
                for(index = 0; index < data.length; ++index) {
                    var c = data[index];
                    html = html + `<tr>
                        <td>
                            ${c.id}
                        </td>
                        <td>
                            ${c.sketchName}
                        </td>
                        <td>
                            ${c.sketchVersion}
                        </td>
                        <td>
                            ${c.lastHeard}
                        </td>
                        <td>
                            ${(c.parentId !== c.id && c.parentId !== null)?c.parentId:''}
                        </td>
                        </tr>`;
                }
                $('#nodelist').html(html);
            });
        }
    });
</script>

<script type="text/x-red" data-template-name="myscontroller">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-database"><i class="icon-tag"></i> Database</label>
        <input type="text" id="node-input-database" placeholder="Database">
    </div>
    <div class="form-row">
            <label for="node-input-handleid"><i class="icon-tag"></i> Handle IDs</label>
            <input type="checkbox" id="node-input-handleid">
    </div>
    <div class="form-row">
        <label><i class="icon-book"></i> List of nodes</label>
        <table border="1px" style="width:100%">
            <thead>
                <tr>
                    <th>id</th>
                    <th>sketch</th>
                    <th>version</th>
                    <th>last heard</th>
                    <th>via</th>
                </tr>
            </thead>
            <tbody id="nodelist">
            </tbody>
        </table>
    </div>
</script>

<script type="text/x-red" data-help-name="myscontroller">
    <p>Controller node for mysensors network. It is capable of keeping track of used node IDs, and can hand out ned node IDs upon request from new nodes</p>

    <h3>Input</h3>
    <p>
        The myscontroller node automatically detects if the input is in one of the following formats:
        <ul>
            <li>Serial gateway</i>
            <li>MQTT input</i>
            <li>Decoded Mysensors package</i>
        </ul>
        It will use the same format on the output, as detected on input.
    </p>
    <h1>Output</h1>
    <p>
        Currently the only time a new message is emitted, is if an ID request is received on the input. Then the emitted message will be a response for the ID request
    </p>
    <h1>Data collection</h1>
    <p>
        The node collects data about nodes that it hears on the mysensors network, such as nodeID, sketchname, timestamp for when it was heard last etc.

        the current list of nodes will be shown in the configuration panel of the controller node
    </p>
    <h1>Database</h1>
    <p>
        Before using this node, you need to define a database file.
    </p>
</script>
